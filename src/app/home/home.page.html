<ion-content [fullscreen]="true" class="ion-padding" [class.connected]="connected" [class.emergency-active]="alarmeAtivo">
  <ion-toolbar>
    <ion-title class="ion-text-center">{{ connected ? 'Acione o BotÃ£o!' : 'Conecte ao Bluetooth' }}</ion-title>
  </ion-toolbar>

  <!-- Card de LocalizaÃ§Ã£o (somente quando alarme estÃ¡ ATIVO) -->
  <div *ngIf="alarmeAtivo && (currentLocation || locationLoading)" style="margin-bottom: 12px;">
    <ion-item lines="none" style="--background: #fff3cd; border-radius: 8px; border: 2px solid #ff6b6b;">
      <ion-icon name="location-outline" slot="start" color="danger"></ion-icon>
      <ion-label>
        <div *ngIf="locationLoading" style="display: flex; align-items: center; gap: 8px;">
          <ion-spinner name="crescent" color="danger"></ion-spinner>
          <span style="font-size: 0.9em; color: #856404;">Obtendo localizaÃ§Ã£o...</span>
        </div>

        <div *ngIf="!locationLoading && currentLocation">
          <p style="margin: 4px 0; font-size: 0.9em; color: #721c24;">
            <strong>ðŸš¨ ALARME ATIVO</strong>
          </p>
          <p style="margin: 4px 0; font-size: 0.85em; color: #856404;">
            <strong>{{ locationAddress }}</strong>
          </p>
          <p style="margin: 4px 0; font-size: 0.75em; color: #666;">
            {{ coordenadasFormatadas }} (Â±{{ currentLocation.accuracy.toFixed(0) }}m)
          </p>
        </div>
      </ion-label>
    </ion-item>
  </div>

  <!-- Estado DESconectado: mostrar mapeamento e lista -->
  <ng-container *ngIf="!connected; else conectadoTemplate">
    <div
      style="
        display: flex;
        gap: 8px;
        justify-content: center;
        flex-wrap: wrap;
        margin-bottom: 8px;
      "
    >
      <ion-button (click)="listarDispositivos()" [disabled]="scanning">
        <ng-container *ngIf="!scanning; else scn">Mapear dispositivos</ng-container>
      </ion-button>
      <ng-template #scn>
        <ion-spinner name="dots"></ion-spinner>
      </ng-template>
    </div>

    <ion-list *ngIf="devices?.length">
      <ion-item *ngFor="let d of devices">
        <div
          style="
            display: flex;
            align-items: center;
            gap: 8px;
            width: 100%;
            justify-content: space-between;
          "
        >
          <div>
            <strong style="color: #ff0000; font-size: 1em;">{{ d.name || 'Sem nome' }}</strong>
            <small *ngIf="d.paired" style="color: #3a7">(pareado)</small>
            <div><small style="color: #666;">{{ d.id }}</small></div>
          </div>
          <div>
            <ion-button
              size="small"
              (click)="conectarDispositivo(d)"
              [disabled]="connectingId === d.id"
            >
              {{ connectingId === d.id ? 'Conectando...' : 'Conectar' }}
            </ion-button>
          </div>
        </div>
      </ion-item>
    </ion-list>
  </ng-container>

  <!-- Estado CONECTADO: mostrar apenas botÃ£o de alarme e desconectar -->
  <ng-template #conectadoTemplate>
    <div class="ion-text-center" style="margin-top: 12px">
      <p class="texto-conectado"><small>Conectado a: {{ connected?.name || connected?.id }}</small></p>
    </div>
    <div class="centraliza-botao">
      <ion-button
        class="botao-grande"
        (click)="toggleAlarme()"
        [color]="alarmeAtivo ? 'danger' : 'primary'"
        [disabled]="locationLoading"
      >
        <ion-spinner
          *ngIf="locationLoading"
          slot="icon-only"
          name="crescent"
        ></ion-spinner>
        <ion-icon
          *ngIf="!locationLoading"
          slot="icon-only"
          size="large"
          name="power-outline"
        ></ion-icon>
      </ion-button>
      <div class="rotulo-alarme">
        <span *ngIf="!alarmeAtivo && !locationLoading">Ativar alarme</span>
        <span *ngIf="alarmeAtivo && !locationLoading">Desativar alarme</span>
        <span *ngIf="locationLoading">Obtendo localizaÃ§Ã£o...</span>
      </div>
    </div>
    <div style="display: flex; justify-content: center; margin-top: 8px">
      <ion-button color="medium" (click)="desconectar()">Desconectar</ion-button>
    </div>
  </ng-template>

  <!-- Mensagens -->
  <div
    class="ion-text-center"
    *ngIf="infoMessage || errorMessage"
    style="margin-top: 12px"
  >
    <p *ngIf="infoMessage" class="texto-info"><small>{{ infoMessage }}</small></p>
    <p *ngIf="errorMessage" class="texto-erro">
      <small>{{ errorMessage }}</small>
    </p>
  </div>
</ion-content>

<ion-footer class="ion-footer" collapse="fade">
  <ion-tab-bar color="light">
    <ion-tab-button [routerLink]="['/news']" tab="1">
      <ion-icon name="earth-outline"></ion-icon>
      <ion-label>Dicas de SaÃºde</ion-label>
    </ion-tab-button>

    <ion-tab-button [routerLink]="['/home']" tab="2">
      <ion-icon name="home-outline"></ion-icon>
      <ion-label>Home</ion-label>
      <ion-badge *ngIf="alarmeAtivo" color="danger">!</ion-badge>
    </ion-tab-button>

    <ion-tab-button [routerLink]="['/about']" tab="3">
      <ion-icon name="information-circle-outline"></ion-icon>
      <ion-label>Sobre</ion-label>
    </ion-tab-button>
  </ion-tab-bar>
</ion-footer>
