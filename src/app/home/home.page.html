<ion-content [fullscreen]="true" class="ion-padding" [class.connected]="connected" [class.emergency-active]="alarmeAtivo">
  <ion-toolbar>
    <ion-title class="ion-text-center">
      {{ connected ? '' : 'Conecte ao Bluetooth' }}
    </ion-title>
  </ion-toolbar>

  <!-- Card de LocalizaÃ§Ã£o (somente quando alarme estÃ¡ ATIVO) -->
  <div *ngIf="alarmeAtivo && (currentLocation || locationLoading)" class="location-card">
    <ion-item lines="none">
      <ion-icon name="location-outline" slot="start" color="danger"></ion-icon>
      <ion-label>
        <div *ngIf="locationLoading" class="location-loading">
          <ion-spinner name="crescent" color="danger"></ion-spinner>
          <span>Obtendo localizaÃ§Ã£o...</span>
        </div>

        <div *ngIf="!locationLoading && currentLocation" class="location-info">
          <p class="alarm-title">
            <strong>ðŸš¨ ALARME ATIVO</strong>
          </p>
          <p class="address">
            <strong>{{ locationAddress }}</strong>
          </p>
          <p class="coordinates">
            {{ coordenadasFormatadas }} (Â±{{ currentLocation.accuracy.toFixed(0) }}m)
          </p>
        </div>
      </ion-label>
    </ion-item>
  </div>

  <!-- Caixa de Dica SAMU -->
  <div class="emergency-tip-box">
    <ion-card>
      <ion-card-content>
        <div class="tip-header">
          <ion-icon name="medical"></ion-icon>
          <strong>Dica de EmergÃªncia</strong>
        </div>
        <p class="tip-text">
          Em caso de emergÃªncia mÃ©dica, ligue imediatamente para o
          <strong>SAMU</strong>
        </p>
        <ion-button expand="block" href="tel:192" class="samu-button">
          Ligar para 192
        </ion-button>
      </ion-card-content>
    </ion-card>
  </div>

  <!-- Estado DESconectado: mostrar mapeamento e lista -->
  <ng-container *ngIf="!connected; else conectadoTemplate">
    <div class="disconnected-section">
      <div class="button-group">
        <ion-button (click)="listarDispositivos()" [disabled]="scanning">
          <ng-container *ngIf="!scanning; else scn">
            <ion-icon name="bluetooth"></ion-icon>
            Mapear dispositivos
          </ng-container>
        </ion-button>
        <ng-template #scn>
          <ion-spinner name="dots"></ion-spinner>
        </ng-template>
      </div>

      <ion-list *ngIf="devices?.length">
        <ion-item *ngFor="let d of devices">
          <div class="device-info">
            <div class="device-details">
              <div class="device-name">
                {{ d.name || 'Desconhecido' }}
                <span *ngIf="d.paired" class="paired-badge">âœ“ pareado</span>
              </div>
              <div class="device-id">{{ d.id }}</div>
            </div>
            <div class="device-actions">
              <ion-button
                size="small"
                (click)="conectarDispositivo(d)"
                [disabled]="connectingId === d.id"
              >
                <ion-icon
                  *ngIf="connectingId !== d.id"
                  name="wifi-outline"
                  slot="start"
                ></ion-icon>
                {{ connectingId === d.id ? 'Conectando...' : 'Conectar' }}
              </ion-button>
            </div>
          </div>
        </ion-item>
      </ion-list>
    </div>
  </ng-container>

  <!-- Estado CONECTADO: mostrar apenas botÃ£o de alarme e desconectar -->
  <ng-template #conectadoTemplate>
    <div class="connected-section">
      <div class="connection-info">
        <p class="texto-conectado">
          <small>
            Conectado a: {{ connected?.name || connected?.id }}
          </small>
        </p>
      </div>

      <div class="centraliza-botao">
        <ion-button
          class="botao-grande"
          [class.ativo]="alarmeAtivo"
          (click)="toggleAlarme()"
          [color]="alarmeAtivo ? 'danger' : 'success'"
          [disabled]="locationLoading"
        >
          <ion-spinner
            *ngIf="locationLoading"
            slot="icon-only"
            name="crescent"
          ></ion-spinner>
          <ion-icon
            *ngIf="!locationLoading"
            slot="icon-only"
            size="large"
            name="power-outline"
          ></ion-icon>
        </ion-button>

        <div class="rotulo-alarme">
          <span *ngIf="!alarmeAtivo && !locationLoading">Ativar alarme</span>
          <span *ngIf="alarmeAtivo && !locationLoading">Desativar alarme</span>
          <span *ngIf="locationLoading">Obtendo localizaÃ§Ã£o...</span>
        </div>
      </div>

      <div class="disconnect-button">
        <ion-button (click)="desconectar()">
          <ion-icon name="close-circle"></ion-icon>
          Desconectar
        </ion-button>
      </div>
    </div>
  </ng-template>

  <!-- Mensagens -->
  <div class="messages-section" *ngIf="infoMessage || errorMessage">
    <p *ngIf="infoMessage" class="texto-info">
      <small>{{ infoMessage }}</small>
    </p>
    <p *ngIf="errorMessage" class="texto-erro">
      <small>{{ errorMessage }}</small>
    </p>
  </div>
</ion-content>

<app-footer-navigation
  [alarmeAtivo]="alarmeAtivo"
  currentPage="home">
</app-footer-navigation>
